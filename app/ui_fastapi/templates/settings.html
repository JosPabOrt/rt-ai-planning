<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Halcyon QA ‚Äì Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
<div class="page" id="settings-root"
     data-site="{{ ui_config.meta.effective_site }}"
     data-clinic-id="{{ ui_config.meta.clinic_profile.clinic_id }}"
     data-machine="{{ ui_config.meta.machine_profile.machine_id }}">

  <!-- CABECERA / NAV TABS -->
  <header class="header header-settings">
    <div class="header-left">
      <h1>Halcyon QA ‚Äì Settings</h1>
      <p class="subtitle">Prototype ¬∑ FastAPI</p>

      <nav class="tabs-nav">
        <a href="/" class="tab-link">Panel</a>
        <a href="/settings" class="tab-link tab-link-active">Settings</a>
      </nav>
    </div>

    <button id="theme_toggle" type="button" class="btn-ghost">
      üåô Dark mode
    </button>
  </header>

  <!-- BLOQUE PRINCIPAL -->
  <main class="settings-main">

    <!-- CARD: Configuraci√≥n de QA -->
    <section class="card">
      <h2>Configuraci√≥n de QA</h2>

      <form method="get" action="/settings" class="settings-form-row">
        <div class="form-row inline">
          <label for="site">Site cl√≠nico</label>
          <input type="text" id="site" name="site"
                 value="{{ site or ui_config.meta.effective_site }}">
        </div>

        <div class="form-row inline">
          <label for="clinic_id">Perfil de cl√≠nica</label>
          <input type="text" id="clinic_id" name="clinic_id"
                 value="{{ clinic_id or ui_config.meta.clinic_profile.clinic_id }}">
        </div>

        <div class="form-row inline">
          <label for="machine">M√°quina</label>
          <input type="text" id="machine" name="machine"
                 value="{{ machine or ui_config.meta.machine_profile.machine_id }}">
        </div>

        <button type="submit" class="btn-primary">
          Cargar configuraci√≥n
        </button>
      </form>
    </section>

    <!-- CARD: Resumen -->
    <section class="card">
      <h2>Resumen de configuraci√≥n actual</h2>
      <div class="summary-grid">
        <div>
          <div class="summary-label">Site</div>
          <div class="summary-value">
            {{ ui_config.meta.effective_site }}
          </div>
        </div>
        <div>
          <div class="summary-label">Perfil de cl√≠nica</div>
          <div class="summary-value">
            {{ ui_config.meta.clinic_profile.label }}
          </div>
        </div>
        <div>
          <div class="summary-label">Secciones</div>
          <div class="summary-value">
            {{ ui_config.sections | length }}
          </div>
        </div>
        <div>
          <div class="summary-label">Nota</div>
          <div class="summary-value">
            <span class="badge badge-warn">
              Esta UI solo guarda overrides, no toca config.py.
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- CARD: Configuraci√≥n por secci√≥n -->
    <section class="card">
      <div class="settings-header-row">
        <h2>Configuraci√≥n por secci√≥n</h2>
        <button type="button" id="btn-save-overrides" class="btn-primary">
          Guardar cambios
        </button>
      </div>

    <!-- Despu√©s del bot√≥n "Guardar cambios" en la secci√≥n de configuraci√≥n por secci√≥n -->
    <div class="note-box">
        <strong>Nota:</strong> Al guardar los cambios, se recomienda volver a ejecutar el QA 
        para ver los cambios reflejados en los resultados. Ser√°s redirigido autom√°ticamente 
        al panel principal.
    </div>

    <style>
        .note-box {
        background-color: #f0f8ff;
        border-left: 4px solid #3498db;
        padding: 12px;
        margin-top: 20px;
        border-radius: 4px;
        font-size: 0.95em;
        }
    </style>

      <!-- Pills de secciones -->
      <div class="section-pills">
        {% for sec in ui_config.sections %}
          <button type="button"
                  class="pill section-pill {% if loop.first %}active{% endif %}"
                  data-section="{{ sec.id }}">
            {{ sec.id }}
          </button>
        {% endfor %}
      </div>

      <!-- Detalle de cada secci√≥n -->
      {% for sec in ui_config.sections %}
      <div class="section-card {% if not loop.first %}hidden{% endif %}"
           data-section="{{ sec.id }}">
        <h3>{{ sec.label }}</h3>

        <div class="section-meta-grid">
          <div>
            <div class="summary-label">ID secci√≥n</div>
            <div class="summary-value">{{ sec.id }}</div>
          </div>
          <div>
            <div class="summary-label">Enabled</div>
            <div class="summary-value">
              <label class="inline">
                <input type="checkbox"
                       class="section-enabled"
                       {% if sec.enabled %}checked{% endif %}>
                Activar secci√≥n
              </label>
            </div>
          </div>
          <div>
            <div class="summary-label">Peso secci√≥n</div>
            <div class="summary-value">
              <input type="number"
                     class="section-weight"
                     step="0.01"
                     min="0"
                     max="5"
                     value="{{ '%.2f'|format(sec.weight) }}">
            </div>
          </div>
          <div>
            <div class="summary-label">Checks en secci√≥n</div>
            <div class="summary-value">
              {{
                ui_config.checks
                | selectattr("section", "equalto", sec.id)
                | list
                | length
              }}
            </div>
          </div>
        </div>

        <!-- Tabla de checks individuales de esta secci√≥n -->
        <h4>Checks individuales</h4>

        <table class="qa-table settings-checks-table">
          <thead>
          <tr>
            <th>Check</th>
            <th>Enabled</th>
            <th>Peso</th>
            <th>Descripci√≥n</th>
          </tr>
          </thead>
          <tbody>
          {% for ck in ui_config.checks if ck.section == sec.id %}
            <tr class="settings-check-row"
                data-section="{{ sec.id }}"
                data-check-id="{{ ck.id }}">
              <td>
                <strong>{{ ck.label }}</strong><br>
                <small>{{ ck.check_key }}</small>
              </td>
              <td class="col-enabled">
                <input type="checkbox"
                       class="check-enabled"
                       {% if ck.enabled %}checked{% endif %}>
              </td>
              <td class="col-weight">
                <input type="number"
                       class="check-weight"
                       step="0.1"
                       min="0"
                       max="5"
                       value="{{ '%.1f'|format(ck.weight) }}">
              </td>
              <td class="col-desc">
                <input type="text"
                       class="check-desc"
                       value="{{ ck.description or '' }}">
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

      </div>
      {% endfor %}
    </section>

    <!-- CARD: Estado de validaci√≥n -->
    <section class="card">
      <h2>Estado de validaci√≥n de la config</h2>
      <p>
        ok: <strong>{{ ui_config.validation.ok }}</strong><br>
        errors: {{ ui_config.validation.errors | length }} ¬∑
        warnings: {{ ui_config.validation.warnings | length }}
      </p>

      {% if ui_config.validation.errors %}
        <details open>
          <summary>Errores</summary>
          <ul>
            {% for e in ui_config.validation.errors %}
              <li>{{ e }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}

      {% if ui_config.validation.warnings %}
        <details>
          <summary>Warnings</summary>
          <ul>
            {% for w in ui_config.validation.warnings %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}
    </section>

  </main>
</div>

<!-- ================== JS MODO OSCURO ================== -->
<script>
  (function () {
      const toggle = document.getElementById('theme_toggle');
      const body   = document.body;

      const stored = window.localStorage.getItem('qa_theme');
      if (stored === 'dark') {
          body.classList.add('theme-dark');
          if (toggle) toggle.textContent = '‚òÄÔ∏è Light mode';
      }

      if (toggle) {
          toggle.addEventListener('click', function () {
              const isDark = body.classList.toggle('theme-dark');
              window.localStorage.setItem('qa_theme', isDark ? 'dark' : 'light');
              toggle.textContent = isDark ? '‚òÄÔ∏è Light mode' : 'üåô Dark mode';
          });
      }
  })();
</script>

<script>
// ==================== BARRA DE PROGRESO MEJORADA ====================
document.addEventListener('DOMContentLoaded', function() {
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressPercent = document.getElementById('progress-percent');
    const progressMessage = document.getElementById('progress-message');
    const progressStep = document.getElementById('progress-step');
    const runForm = document.querySelector('form[action="/run"]');
    
    // Estados del progreso del QA
    const qaStages = {
        validating: { min: 0, max: 10, message: "Validando rutas de archivos..." },
        loadingDicom: { min: 10, max: 70, message: "Cargando archivos DICOM (esto puede tomar 15-20 segundos)..." },
        processingCT: { min: 70, max: 80, message: "Procesando CT..." },
        processingStructures: { min: 80, max: 85, message: "Analizando estructuras..." },
        processingPlan: { min: 85, max: 90, message: "Analizando plan..." },
        processingDose: { min: 90, max: 95, message: "Calculando dosis..." },
        finalizing: { min: 95, max: 100, message: "Finalizando..." }
    };
    
    let currentStage = 'validating';
    let currentProgress = 0;
    let progressInterval;
    let stageStartTime;
    let estimatedStageDurations = {
        validating: 1000, // 1 segundo
        loadingDicom: 20000, // 20 segundos (estimado)
        processingCT: 1000,
        processingStructures: 1000,
        processingPlan: 1000,
        processingDose: 1000,
        finalizing: 500
    };
    
    function updateProgress() {
        const stage = qaStages[currentStage];
        const now = Date.now();
        const elapsed = now - stageStartTime;
        const estimatedDuration = estimatedStageDurations[currentStage] || 5000;
        
        // Calcular progreso dentro de esta etapa
        let stageProgress = Math.min(elapsed / estimatedDuration, 1);
        currentProgress = stage.min + (stage.max - stage.min) * stageProgress;
        
        // Actualizar UI
        progressFill.style.width = `${currentProgress}%`;
        progressPercent.textContent = `${Math.round(currentProgress)}%`;
        progressMessage.textContent = stage.message;
        progressStep.textContent = `Etapa: ${currentStage.replace(/([A-Z])/g, ' $1').trim()}`;
        
        // Si terminamos esta etapa, pasar a la siguiente
        if (stageProgress >= 1) {
            const stages = Object.keys(qaStages);
            const currentIndex = stages.indexOf(currentStage);
            if (currentIndex < stages.length - 1) {
                currentStage = stages[currentIndex + 1];
                stageStartTime = Date.now();
            } else {
                // √öltima etapa - mantener en 100%
                progressMessage.textContent = "‚úÖ QA completado, cargando resultados...";
            }
        }
    }
    
    // Mostrar progreso al enviar el formulario
    if (runForm) {
        runForm.addEventListener('submit', function(e) {
            // No prevenir el env√≠o - dejar que el formulario se env√≠e normalmente
            // Solo mostramos la barra de progreso
            
            // Mostrar contenedor
            progressContainer.classList.remove('hidden');
            
            // Resetear progreso
            currentStage = 'validating';
            currentProgress = 0;
            stageStartTime = Date.now();
            
            // Actualizar UI inicial
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressMessage.textContent = qaStages.validating.message;
            progressStep.textContent = 'Iniciando QA...';
            
            // Iniciar actualizaciones cada 100ms
            clearInterval(progressInterval);
            progressInterval = setInterval(updateProgress, 100);
            
            // Ocultar mensaje de √©xito si existe
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                successAlert.style.display = 'none';
            }
            
            // Tambi√©n ocultar resultados anteriores mientras carga
            const resultSection = document.querySelector('section.card');
            if (resultSection) {
                resultSection.style.opacity = '0.5';
            }
        });
    }
    
    // Cuando la p√°gina carga con resultados (despu√©s del QA), ocultar la barra
    window.addEventListener('load', function() {
        if (document.querySelector('.summary-card')) {
            progressContainer.classList.add('hidden');
            const resultSection = document.querySelector('section.card');
            if (resultSection) {
                resultSection.style.opacity = '1';
            }
        }
    });
    
    // Tambi√©n detectar si hay un QA en progreso cuando se recarga la p√°gina
    if (window.performance && window.performance.navigation) {
        if (window.performance.navigation.type === 1) { // Tipo 1 es reload
            // Verificar si hab√≠a un QA reciente (podr√≠as usar sessionStorage)
            const lastQATime = sessionStorage.getItem('lastQAStart');
            if (lastQATime && (Date.now() - parseInt(lastQATime) < 30000)) {
                // Mostrar barra porque el QA podr√≠a estar en progreso
                progressContainer.classList.remove('hidden');
            }
        }
    }
    
    // Guardar hora de inicio del QA
    if (runForm) {
        runForm.addEventListener('submit', function() {
            sessionStorage.setItem('lastQAStart', Date.now().toString());
        });
    }
});

// ==================== AUTO-SCROLL MEJORADO ====================
document.addEventListener('DOMContentLoaded', function() {
    // Si hay un mensaje en la URL, mostrarlo y hacer scroll
    const urlParams = new URLSearchParams(window.location.search);
    const message = urlParams.get('message');
    
    if (message) {
        // Decodificar el mensaje (est√° URL-encoded)
        const decodedMessage = decodeURIComponent(message);
        
        // Crear alerta si no existe
        if (!document.querySelector('.alert-success')) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-success';
            alertDiv.innerHTML = `‚úÖ ${decodedMessage}`;
            
            // Insertar despu√©s del header
            const header = document.querySelector('.header');
            if (header) {
                header.parentNode.insertBefore(alertDiv, header.nextSibling);
            }
            
            // Hacer scroll suave a la alerta
            setTimeout(() => {
                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-ocultar despu√©s de 8 segundos
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 300);
                }, 8000);
            }, 300);
        }
    }
});
</script>

<!-- Modal de Confirmaci√≥n Personalizado -->
<div id="confirmation-modal" class="confirmation-modal" aria-hidden="true">
    <div class="confirmation-modal-backdrop"></div>
    
    <div class="confirmation-content">
        <div class="confirmation-header">
            <div class="confirmation-icon">‚úÖ</div>
            <h3 class="confirmation-title">Configuraci√≥n Guardada</h3>
        </div>
        
        <div class="confirmation-body">
            <p>Los cambios se han guardado exitosamente en <code>qa_overrides.json</code>.</p>
            <p>¬øTe gustar√≠a volver al panel principal y ejecutar el QA para ver los cambios aplicados?</p>
        </div>
        
        <div class="confirmation-footer">
            <button type="button" class="confirmation-btn confirmation-btn-secondary" id="confirmation-cancel">
                Permanecer aqu√≠
            </button>
            <button type="button" class="confirmation-btn confirmation-btn-primary" id="confirmation-accept">
                Ir al Panel y Ejecutar QA
            </button>
        </div>
    </div>
</div>

<!-- JavaScript para el modal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationCancel = document.getElementById('confirmation-cancel');
    const confirmationAccept = document.getElementById('confirmation-accept');
    
    // Mostrar modal cuando se guarda (detectamos el submit del formulario)
    const saveForm = document.querySelector('form[method="post"]');
    if (saveForm) {
        saveForm.addEventListener('submit', function(e) {
            // Prevenir el env√≠o normal (queremos mostrar nuestro modal primero)
            e.preventDefault();
            
            // Obtener los datos del formulario
            const formData = new FormData(this);
            
            // Mostrar nuestro modal personalizado
            confirmationModal.classList.add('is-open');
            
            // Guardar la configuraci√≥n en segundo plano cuando el usuario acepta
            confirmationAccept.addEventListener('click', function saveAndRedirect() {
                // Enviar el formulario realmente
                fetch('/settings/save', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Redirigir al panel principal
                        window.location.href = '/';
                    } else {
                        alert('Error al guardar la configuraci√≥n');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexi√≥n');
                });
                
                // Remover el event listener para evitar m√∫ltiples ejecuciones
                confirmationAccept.removeEventListener('click', saveAndRedirect);
            }, { once: true }); // El { once: true } asegura que se ejecute solo una vez
            
            // Cancelar: solo cerrar el modal
            confirmationCancel.addEventListener('click', function() {
                confirmationModal.classList.remove('is-open');
            });
        });
    }
    
    // Tambi√©n cerrar con ESC o haciendo clic en el backdrop
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && confirmationModal.classList.contains('is-open')) {
            confirmationModal.classList.remove('is-open');
        }
    });
    
    confirmationModal.querySelector('.confirmation-modal-backdrop').addEventListener('click', function() {
        confirmationModal.classList.remove('is-open');
    });
});
</script>

</body>
</html>
