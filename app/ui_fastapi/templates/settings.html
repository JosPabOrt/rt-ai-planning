<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Halcyon QA ‚Äì Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
<div class="page" id="settings-root"
     data-site="{{ ui_config.meta.effective_site }}"
     data-clinic-id="{{ ui_config.meta.clinic_profile.clinic_id }}"
     data-machine="{{ ui_config.meta.machine_profile.machine_id }}">

  <!-- CABECERA / NAV TABS -->
  <header class="header header-settings">
    <div class="header-left">
      <h1>Halcyon QA ‚Äì Settings</h1>
      <p class="subtitle">Prototype ¬∑ FastAPI</p>

      <nav class="tabs-nav">
        <a href="/" class="tab-link">Panel</a>
        <a href="/settings" class="tab-link tab-link-active">Settings</a>
      </nav>
    </div>

    <button id="theme_toggle" type="button" class="btn-ghost">
      üåô Dark mode
    </button>
  </header>

  <!-- BLOQUE PRINCIPAL -->
  <main class="settings-main">

    <!-- CARD: Configuraci√≥n de QA -->
    <section class="card">
      <h2>Configuraci√≥n de QA</h2>

      <form method="get" action="/settings" class="settings-form-row">
        <div class="form-row inline">
          <label for="site">Site cl√≠nico</label>
          <input type="text" id="site" name="site"
                 value="{{ site or ui_config.meta.effective_site }}">
        </div>

        <div class="form-row inline">
          <label for="clinic_id">Perfil de cl√≠nica</label>
          <input type="text" id="clinic_id" name="clinic_id"
                 value="{{ clinic_id or ui_config.meta.clinic_profile.clinic_id }}">
        </div>

        <div class="form-row inline">
          <label for="machine">M√°quina</label>
          <input type="text" id="machine" name="machine"
                 value="{{ machine or ui_config.meta.machine_profile.machine_id }}">
        </div>

        <button type="submit" class="btn-primary">
          Cargar configuraci√≥n
        </button>
      </form>
    </section>

    <!-- CARD: Resumen -->
    <section class="card">
      <h2>Resumen de configuraci√≥n actual</h2>
      <div class="summary-grid">
        <div>
          <div class="summary-label">Site</div>
          <div class="summary-value">
            {{ ui_config.meta.effective_site }}
          </div>
        </div>
        <div>
          <div class="summary-label">Perfil de cl√≠nica</div>
          <div class="summary-value">
            {{ ui_config.meta.clinic_profile.label }}
          </div>
        </div>
        <div>
          <div class="summary-label">Secciones</div>
          <div class="summary-value">
            {{ ui_config.sections | length }}
          </div>
        </div>
        <div>
          <div class="summary-label">Nota</div>
          <div class="summary-value">
            <span class="badge badge-warn">
              Esta UI solo guarda overrides, no toca config.py.
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- CARD: Configuraci√≥n por secci√≥n -->
    <section class="card">
      <div class="settings-header-row">
        <h2>Configuraci√≥n por secci√≥n</h2>
        <button type="button" id="btn-save-overrides" class="btn-primary">
          Guardar cambios
        </button>
      </div>

      <!-- Pills de secciones -->
      <div class="section-pills">
        {% for sec in ui_config.sections %}
          <button type="button"
                  class="pill section-pill {% if loop.first %}active{% endif %}"
                  data-section="{{ sec.id }}">
            {{ sec.id }}
          </button>
        {% endfor %}
      </div>

      <!-- Detalle de cada secci√≥n -->
      {% for sec in ui_config.sections %}
      <div class="section-card {% if not loop.first %}hidden{% endif %}"
           data-section="{{ sec.id }}">
        <h3>{{ sec.label }}</h3>

        <div class="section-meta-grid">
          <div>
            <div class="summary-label">ID secci√≥n</div>
            <div class="summary-value">{{ sec.id }}</div>
          </div>
          <div>
            <div class="summary-label">Enabled</div>
            <div class="summary-value">
              <label class="inline">
                <input type="checkbox"
                       class="section-enabled"
                       {% if sec.enabled %}checked{% endif %}>
                Activar secci√≥n
              </label>
            </div>
          </div>
          <div>
            <div class="summary-label">Peso secci√≥n</div>
            <div class="summary-value">
              <input type="number"
                     class="section-weight"
                     step="0.01"
                     min="0"
                     max="5"
                     value="{{ '%.2f'|format(sec.weight) }}">
            </div>
          </div>
          <div>
            <div class="summary-label">Checks en secci√≥n</div>
            <div class="summary-value">
              {{
                ui_config.checks
                | selectattr("section", "equalto", sec.id)
                | list
                | length
              }}
            </div>
          </div>
        </div>

        <!-- Tabla de checks individuales de esta secci√≥n -->
        <h4>Checks individuales</h4>

        <table class="qa-table settings-checks-table">
          <thead>
          <tr>
            <th>Check</th>
            <th>Enabled</th>
            <th>Peso</th>
            <th>Descripci√≥n</th>
          </tr>
          </thead>
          <tbody>
          {% for ck in ui_config.checks if ck.section == sec.id %}
            <tr class="settings-check-row"
                data-section="{{ sec.id }}"
                data-check-id="{{ ck.id }}">
              <td>
                <strong>{{ ck.label }}</strong><br>
                <small>{{ ck.check_key }}</small>
              </td>
              <td class="col-enabled">
                <input type="checkbox"
                       class="check-enabled"
                       {% if ck.enabled %}checked{% endif %}>
              </td>
              <td class="col-weight">
                <input type="number"
                       class="check-weight"
                       step="0.1"
                       min="0"
                       max="5"
                       value="{{ '%.1f'|format(ck.weight) }}">
              </td>
              <td class="col-desc">
                <input type="text"
                       class="check-desc"
                       value="{{ ck.description or '' }}">
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

      </div>
      {% endfor %}
    </section>

    <!-- CARD: Estado de validaci√≥n -->
    <section class="card">
      <h2>Estado de validaci√≥n de la config</h2>
      <p>
        ok: <strong>{{ ui_config.validation.ok }}</strong><br>
        errors: {{ ui_config.validation.errors | length }} ¬∑
        warnings: {{ ui_config.validation.warnings | length }}
      </p>

      {% if ui_config.validation.errors %}
        <details open>
          <summary>Errores</summary>
          <ul>
            {% for e in ui_config.validation.errors %}
              <li>{{ e }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}

      {% if ui_config.validation.warnings %}
        <details>
          <summary>Warnings</summary>
          <ul>
            {% for w in ui_config.validation.warnings %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}
    </section>

  </main>
</div>

<!-- ================== JS MODO OSCURO ================== -->
<script>
  (function () {
      const toggle = document.getElementById('theme_toggle');
      const body   = document.body;

      const stored = window.localStorage.getItem('qa_theme');
      if (stored === 'dark') {
          body.classList.add('theme-dark');
          if (toggle) toggle.textContent = '‚òÄÔ∏è Light mode';
      }

      if (toggle) {
          toggle.addEventListener('click', function () {
              const isDark = body.classList.toggle('theme-dark');
              window.localStorage.setItem('qa_theme', isDark ? 'dark' : 'light');
              toggle.textContent = isDark ? '‚òÄÔ∏è Light mode' : 'üåô Dark mode';
          });
      }
  })();
</script>

<!-- ================== JS SETTINGS ================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const root = document.getElementById("settings-root");
  const saveBtn = document.getElementById("btn-save-overrides");

  // --- Navegaci√≥n por secci√≥n (pills) ---
  const pills = document.querySelectorAll(".section-pill");
  const sectionCards = document.querySelectorAll(".section-card");

  pills.forEach(pill => {
    pill.addEventListener("click", () => {
      const secId = pill.dataset.section;

      pills.forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      sectionCards.forEach(card => {
        if (card.dataset.section === secId) {
          card.classList.remove("hidden");
        } else {
          card.classList.add("hidden");
        }
      });
    });
  });

  // --- Recolectar overrides desde la UI ---
  function collectOverrides() {
    const sections = {};
    const checks = {};

    // Secciones
    sectionCards.forEach(card => {
      const secId = card.dataset.section;
      const enabledInput = card.querySelector(".section-enabled");
      const weightInput  = card.querySelector(".section-weight");

      sections[secId] = {
        enabled: enabledInput ? enabledInput.checked : true,
        weight:  weightInput ? parseFloat(weightInput.value || "0") : 1.0,
      };
    });

    // Checks
    const checkRows = document.querySelectorAll(".settings-check-row");
    checkRows.forEach(row => {
      const checkId = row.dataset.checkId;
      const enabled = row.querySelector(".check-enabled");
      const weight  = row.querySelector(".check-weight");
      const desc    = row.querySelector(".check-desc");

      checks[checkId] = {
        enabled: enabled ? enabled.checked : true,
        weight:  weight ? parseFloat(weight.value || "0") : 1.0,
        description: desc ? desc.value : "",
      };
    });

    return { sections, checks };
  }

  // --- Guardar (POST /api/settings/save) ---
  async function saveOverrides() {
    if (!root) return;

    const meta = {
      site: root.dataset.site || "PROSTATE",
      clinic_id: root.dataset.clinicId || "DEFAULT",
      machine: root.dataset.machine || "HALCYON",
    };

    const overrides = collectOverrides();

    const payload = {
      ...meta,
      sections: overrides.sections,
      checks: overrides.checks,
    };

    try {
      const resp = await fetch("/api/settings/save", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        throw new Error("Error HTTP " + resp.status);
      }

      const data = await resp.json();
      console.log("Overrides guardados:", data);

      alert("Overrides guardados en qa_overrides.json");
    } catch (err) {
      console.error(err);
      alert("Error al guardar overrides: " + err.message);
    }
  }

  if (saveBtn) {
    saveBtn.addEventListener("click", saveOverrides);
  }
});
</script>

</body>
</html>
